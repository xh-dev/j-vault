![GitHub Release](https://img.shields.io/github/v/release/xh-dev/j-vault)
![GitHub Actions Workflow Status](https://img.shields.io/github/actions/workflow/status/xh-dev/j-vault/maven.yml)
[![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=xh-dev_j-vault&metric=alert_status)](https://sonarcloud.io/summary/new_code?id=xh-dev_j-vault)


[![SonarQube Cloud](https://sonarcloud.io/images/project_badges/sonarcloud-light.svg)](https://sonarcloud.io/summary/new_code?id=xh-dev_j-vault)

j-vault is a very simple key value based password vault cli program.

User can store secret information in a vault file (generally named as `value.kv``) and retrieve the information with
credentials.

Actually there is already quite a lot of similar products available as open source project, such as `HashiCrop Vault`
and `Ansible Vault`.
But the mentioned options are only available on some specific conditions. The `HashiCrop Vault` requires installation
and accessing through http.
The `Ansible Vault` require python environment.

The problem that i'm facing is that I have to store some `secret` like credential.
The environment only have Java installed and I don't find out of the box implementation. So that I write it on my own.

### Downloads

You can download the java-archive [
`j-vault.jar`](https://github.com/xh-dev/j-vault/releases/latest/download/j-vault.jar). \
Or use curl to download the java-archive.

#### Jar file

```shell
curl -L -O  https://github.com/xh-dev/j-vault/releases/latest/download/j-vault.jar
```

#### Linux executable file

```shell
curl -L -O  https://github.com/xh-dev/j-vault/releases/latest/download/j-vault && chmod +x j-vault
```

Install

```shell
curl -L -O  https://github.com/xh-dev/j-vault/releases/latest/download/j-vault && chmod +x j-vault
sudo mv j-vault /usr/bin # move the executable to system path
j-vault autocomplete > /etc/bash_completion.d/j-vault # export autocomplete script, the path may be different for different platform
```

#### Windows executable file

```shell
curl -L -O  https://github.com/xh-dev/j-vault/releases/latest/download/j-vault.exe
```

### Architecture

The vault is a very simple key value pair based data store.

```
{key1}={value1}
{key2}={value2}
{key3}={value3}
.
.

```

The *key* contains name fulfill below rules:

1. contains at least 1 character
2. starts with upper and lower letters.[a-zA-Z]
3. after the first character, the rest letters can contains upper and lower character and special character like `.`,
   `-`, `_`, `[` and `]`

The *value* should meet the below requirements:

1. value should be plaintext of UTF-8 encoding
2. if storing binary is needed, user should manually encoding the value into UTF-8 encoding.
3. when using `set` command, the UTF-8 encoding data will be further encoded with URL Encoding (Percent Encoding) by the
   j-vault program
4. when using `view` command, all values are rendered as URL Encoded UTF-8 string
5. when using `find` command, the result value is rendered as UTF-8 string, the j-vault will decode the URL encoding
   before render.

The j-vault store the file with AES encryption. The password of the AES key is secured with PBKDF2.

#### Password Components

1. password \
   The user defined password or program generated password, this part of component is kept by the user
2. salt \
   PBKDF2 is used. The AES key is generated base on password and the salt. The salt is divided into two parts.\
   One (*salt-1*) kept by user (4 bytes). The other one (*salt-2*) stored in the encrypted file (32 bytes).
3. IV \
   The IV value is generated by system and store in the encrypted file(16 byes).

### Commands

#### Token

The token is compose as format of `{password}:{salt-1}`. \
The token will be need when using `vault` and `file` command and passing into the program by environment variable
`x-credential` or command options `-c'.

##### Generate password

When call `token gen`, the program generate a random token for the usage of vault.
The *password* generated is 16 byte string with base 64 encoded.

```shell
java -jar j-vault.jar token gen 

# output
#
# +fmIAQyaNbhxrdJ8z4Snng==:W3sV3LhF35U=:2SMQUZMJD8mYJecyL+MHQQ==
```

When call `token gen -p {password}`, the program only generate the *salt-1* and use the user input *password*.

```shell
java -jar j-vault.jar token gen -p {password}

# output
#
# {password}:2SMQUZMJD8mYJecyL+MHQQ==
```

##### Vault

The `vault` command support `set`, `unset`, `view` and `find` sub command.\
Any of the calling for the above command by default generate `vault.kv` file with basic information.\
if don't want the vault named as `vault.kv`, user can add command option `-f {vault name}` to specify the customized
file name. \
The command line format is like `vault -c {token} {sub command} [-f {vault name] {option 1}...{option n}`

```shell
java -jar j-vault.jar vault -c HnP2kqQL/Zm9qYLG6KX2bg==:qNLriw== set -k k -v v
java -jar j-vault.jar vault -c HnP2kqQL/Zm9qYLG6KX2bg==:qNLriw== set -k {key} -v {value}
java -jar j-vault.jar vault -c HnP2kqQL/Zm9qYLG6KX2bg==:qNLriw== view

# Output
#
# k=v
# {key}=%7Bvaule%7D

java -jar j-vault.jar vault -c HnP2kqQL/Zm9qYLG6KX2bg==:qNLriw== unset -k k

# Output
#
# {key}=%7Bvaule%7D

java -jar j-vault.jar vault -c HnP2kqQL/Zm9qYLG6KX2bg==:qNLriw== find -k k
# Output
#
# {key}={value}


The `-c {credential}` option can be replaced by setting up environment variable `x-credential` or `x_credential` in the shell.

##### File
The `file` command support `decrypt` and `encrypt` sub command.\
It simply encrypt and existing file to encrypted file with sample encryption structure as `vault`.\
And simply decrypt encrypted file back to unencrypted.

###### Encrypt

```shell
java -jar j-vault.jar file -c HnP2kqQL/Zm9qYLG6KX2bg==:qNLriw== encrypt \
  -f a.txt \
  -o a.txt.vault
  
# Output
# 
# cat a.txt
# helloworld
# 
# cat a.txt.vault
# CiK5HGq0T8jsUve+mXBSsOVp00l81WIT4mOAcSKwcok=:5nPziuhBP4gQGdXQHM53wg==
# �MY��1��C(�>7�S

```

Decrypt

```shell
java -jar j-vault.jar file -c HnP2kqQL/Zm9qYLG6KX2bg==:qNLriw== decrypt \
  -f a.txt.vault \
  -o a.txt.decrypted
  
# Output
# 
# cat a.txt.vault
# CiK5HGq0T8jsUve+mXBSsOVp00l81WIT4mOAcSKwcok=:5nPziuhBP4gQGdXQHM53wg==
# �MY��1��C(�>7�S
#
# cat a.txt.decrypted
# helloworld
# 

```

For linux bash, it is recommanded to store the password as enviornment variable by following script

```bash
# prevent history command get logged
set +o history

export x_credential={credential}

# unlock the history command logging
set -o history
```

# Releases

| Version | Date        | Description                                                                                                                                |
|---------|-------------|--------------------------------------------------------------------------------------------------------------------------------------------|
| v1.7.0  | 3 Jun 2025  | change sub command `rest-server` to `over-http` and small refactoring                                                                      |
| v1.6.1  | 2 Jun 2025  | - Default port to `7910 instead of `` <br> - Add secure mode (`--harden`, `--secure`) to `j-vault vault rest-server`                       |
| v1.6.0  | 31 May 2025 | Add new command `j-vault vault rest-server` and code refactor                                                                              |
| v1.5.4  | 28 May 2025 | Fix bugs                                                                                                                                   |
| v1.5.3  | 28 May 2025 | Fix bug on build script for native image                                                                                                   |
| v1.5.2  | 27 May 2025 | Refactor auth-server command structure                                                                                                     |
| v1.5.1  | 26 May 2025 | Refactor the --password option to upper level argument                                                                                     |
| v1.5.0  | 25 May 2025 | Add zip file set and unset password function                                                                                               |
| v1.4.0  | 22 May 2025 | Merge [deen-pdf](https://github.com/xh-dev/deen-pdf) into this project                                                                     |
| v1.3.1  | 16 May 2025 | Add docker build for image for simple authentication server                                                                                |
| v1.3.0  | 15 May 2025 | Add support authentication server to preventing frequently password traveling                                                              |
| v1.2.7  | 14 Aug 2024 | Refine `token gen` to support `as-kv-pass` argument                                                                                        |
| v1.2.6  | 14 Aug 2024 | Refine `openssl encrypt`script to support `out-bash-env` argument                                                                          |
| v1.2.5  | 14 Aug 2024 | Refine `openssl encrypt`script                                                                                                             |
| v1.2.4  | 14 Aug 2024 | - Support more output format on `token gen` and `vault veiw` command <br> - Add `openssl encrypt` and `openssl decrypt` script gen feature |
| v1.2.3  | 14 Aug 2024 | Add command of `debug-tools print-env` of feature viewing the system environment variable                                                  |
| v1.2.1  | 12 May 2024 | Support generate exporting linux and windows environment setup script                                                                      |
| v1.2.0  | 11 May 2024 | Add `autocomplete` script generation                                                                                                       |
| v1.1.x  | -           | Add support to `github action` build with jar and executable                                                                               |
| v1.0.4  | 6 Oct 2023  | Add `-k` args for encrypt and decrypt file                                                                                                 |
| v1.0.3  | 3 Oct 2023  | Add `-V` args for checking build version                                                                                                   |
| v1.0.0  | 30 Sep 2023 | First official release                                                                                                                     |

# Graalvm native image

```shell
sudo rm -f out/j-vault \
  && mvn clean compile package \ 
  && docker run \
    --rm -it \
    -v "$(pwd)/target/j-vault.jar:/app/j-vault.jar" \
    -v "$(pwd)/out:/out" \
    ghcr.io/graalvm/native-image-community:21 \
      --no-fallback \
      -H:IncludeResources="version.txt" \
      -jar j-vault.jar \
      /out/j-vault
```
